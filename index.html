<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced Notepad ‚Üí Google Docs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#1e1e2f; --panel:#2a2a3d; --accent:#4cafef; --card:#252540; --text:#f5f5f5;
    }
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,var(--accent),#007acc);padding:12px;text-align:center;font-weight:700}
    #toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;justify-content:center;background:var(--panel);}
    #toolbar button,#toolbar select,#toolbar input{padding:6px 10px;border-radius:6px;border:none;background:#3f3f55;color:#fff;cursor:pointer}
    #toolbar button:hover{background:var(--accent)}
    #container{width:92%;max-width:1100px;margin:16px auto}
    #topbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px}
    #editor-wrap{background:var(--card);padding:14px;border-radius:8px;min-height:420px}
    #workspace{min-height:320px;outline:none}
    input[type="text"]{padding:8px;border-radius:6px;border:none;width:300px}
    .table-editor{border-collapse:collapse;margin:12px 0;width:100%;background:#1e1e2f}
    .table-editor td{border:1px solid #555;padding:10px;color:#fff;min-width:70px;text-align:center}
    .selected{outline:3px solid var(--accent)}
    .small{font-size:0.9rem;padding:6px}
    #status{font-size:0.9rem;color:#ddd}
  </style>
</head>
<body>
  <header>üîê Advanced Notepad ‚Äî Google Docs Sync</header>

  <div id="toolbar">
    <!-- Password / lock -->
    <button id="unlockBtn">Unlock Editor</button>
    <button id="lockBtn" style="display:none">Lock Editor</button>

    <!-- Text tools -->
    <button onclick="formatText('bold')">Bold</button>
    <button onclick="formatText('italic')">Italic</button>
    <button onclick="formatText('underline')">Underline</button>
    <select onchange="formatText('fontSize', this.value)">
      <option value="">Size</option>
      <option value="1">Small</option>
      <option value="3">Normal</option>
      <option value="5">Large</option>
      <option value="7">Huge</option>
    </select>
    <input type="color" onchange="formatText('foreColor', this.value)" title="Text Color">
    <input type="color" onchange="formatText('hiliteColor', this.value)" title="Highlight">

    <!-- Tax (text size global) -->
    <button onclick="adjustFontSize(1)">Tax +</button>
    <button onclick="adjustFontSize(-1)">Tax -</button>

    <!-- Table -->
    <button onclick="insertTable()">Insert Table</button>
    <button onclick="deleteTable()">Delete Table</button>
    <button onclick="addRow()">Add Row</button>
    <button onclick="deleteRow()">Delete Row</button>
    <button onclick="addColumn()">Add Column</button>
    <button onclick="deleteColumn()">Delete Column</button>

    <!-- Google -->
    <button id="authorizeBtn">Authorize Google</button>
    <button id="createBtn">Create to Docs</button>
    <button id="updateBtn">Update Last Doc</button>
    <button id="listBtn">List My Drive</button>

    <a id="signout" href="/signout" style="color:#fff;padding:6px 8px;border-radius:6px;background:#6b6b83;text-decoration:none">Sign out</a>
  </div>

  <div id="container">
    <div id="topbar">
      <input id="title" type="text" placeholder="Document title (for create)" />
      <div id="status">Status: <span id="stText">Not authorized</span></div>
    </div>

    <div id="editor-wrap">
      <div id="workspace" contenteditable="false">
        <p style="margin:0">Unlock to edit. This editor supports rich text, tables and basic formatting.</p>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const EDIT_PASSWORD = "kalu"; // change as you like
/* ---------------------------- */

const workspace = document.getElementById("workspace");
const toolbarBtns = document.querySelectorAll("#toolbar button, #toolbar select, #toolbar input[type='color']");
const unlockBtn = document.getElementById("unlockBtn");
const lockBtn = document.getElementById("lockBtn");
const authorizeBtn = document.getElementById("authorizeBtn");
const createBtn = document.getElementById("createBtn");
const updateBtn = document.getElementById("updateBtn");
const listBtn = document.getElementById("listBtn");
const stText = document.getElementById("stText");

// Keep certain controls hidden until unlocked
function setReadOnlyMode(){
  workspace.contentEditable = "false";
  // hide all controls except unlock and authorize/signout
  toolbarBtns.forEach(btn => {
    if (btn.id === "unlockBtn" || btn.id === "authorizeBtn" || btn.id==="signout") {
      btn.style.display = "inline-block";
    } else {
      btn.style.display = "none";
    }
  });
  lockBtn.style.display = "none";
  unlockBtn.style.display = "inline-block";
}

function setEditMode(){
  workspace.contentEditable = "true";
  toolbarBtns.forEach(btn => btn.style.display = "inline-block");
  unlockBtn.style.display = "none";
  lockBtn.style.display = "inline-block";
}

// Initialize mode based on localStorage
function checkAccess(){
  const stored = localStorage.getItem("notepadUserKey");
  const savedContent = localStorage.getItem("notepadContent");
  if(savedContent) workspace.innerHTML = savedContent;
  if(stored === EDIT_PASSWORD){
    setEditMode();
  } else {
    setReadOnlyMode();
  }
}

unlockBtn.addEventListener("click", () => {
  const input = prompt("Enter password to unlock:");
  if(input === EDIT_PASSWORD){
    localStorage.setItem("notepadUserKey", input);
    alert("‚úÖ Unlocked");
    setEditMode();
  } else {
    alert("‚ùå Wrong password ‚Äî view only.");
  }
});

lockBtn.addEventListener("click", () => {
  localStorage.removeItem("notepadUserKey");
  setReadOnlyMode();
  alert("üîí Locked");
});

// Save/load functions (still keep localStorage as fallback)
function saveLocal(){
  if(workspace.contentEditable === "true"){
    localStorage.setItem("notepadContent", workspace.innerHTML);
    alert("‚úÖ Saved locally");
  } else {
    alert("üîí Unlock to save");
  }
}

function loadLocal(){
  const c = localStorage.getItem("notepadContent");
  if(c) workspace.innerHTML = c;
}

/* TEXT FORMATTING */
function formatText(command, value=null){
  document.execCommand(command, false, value);
}

/* TAX = global font size adjust */
function adjustFontSize(delta){
  const style = window.getComputedStyle(workspace).getPropertyValue("font-size");
  const current = parseFloat(style) || 16;
  workspace.style.fontSize = (current + delta*2) + "px";
}

/* TABLE MANAGEMENT */
let selectedTable = null;
document.addEventListener("click", e => {
  const t = e.target.closest("table");
  if(t){
    if(selectedTable) selectedTable.classList.remove("selected");
    selectedTable = t;
    selectedTable.classList.add("selected");
  } else {
    if(selectedTable) selectedTable.classList.remove("selected");
    selectedTable = null;
  }
});

function insertTable(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  const rows = parseInt(prompt("Rows:", 2));
  const cols = parseInt(prompt("Cols:", 2));
  if(!rows || !cols) return;
  const table = document.createElement("table");
  table.className = "table-editor";
  for(let i=0;i<rows;i++){
    const tr = document.createElement("tr");
    for(let j=0;j<cols;j++){
      const td = document.createElement("td");
      td.contentEditable = "true";
      td.innerText = `Cell ${i+1}-${j+1}`;
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  workspace.appendChild(table);
}

function deleteTable(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  if(selectedTable){
    selectedTable.remove();
    selectedTable = null;
  } else alert("Select a table first");
}

function addRow(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  if(!selectedTable) return alert("Select a table first");
  const cols = selectedTable.rows[0].cells.length;
  const tr = document.createElement("tr");
  for(let i=0;i<cols;i++){
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.innerText = "New Cell";
    tr.appendChild(td);
  }
  selectedTable.appendChild(tr);
}

function deleteRow(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  if(!selectedTable) return alert("Select a table first");
  if(selectedTable.rows.length>0) selectedTable.deleteRow(-1);
}

function addColumn(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  if(!selectedTable) return alert("Select a table first");
  for(const r of selectedTable.rows){
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.innerText = "New Col";
    r.appendChild(td);
  }
}

function deleteColumn(){
  if(workspace.contentEditable !== "true") return alert("Unlock to edit");
  if(!selectedTable) return alert("Select a table first");
  const colCount = selectedTable.rows[0].cells.length;
  if(colCount>0){
    for(const r of selectedTable.rows) r.deleteCell(-1);
  }
}

/* GOOGLE DOCS INTEGRATION */
// Update UI based on authorization state by calling /list_my_doc (simple probe)
async function checkAuthStatus(){
  try {
    const res = await fetch("/list_my_doc");
    if(res.status === 401){
      stText.innerText = "Not authorized";
    } else {
      stText.innerText = "Authorized";
    }
  } catch(e){
    stText.innerText = "Unknown";
  }
}
checkAuthStatus();

authorizeBtn.addEventListener("click", () => { window.location = "/authorize"; });

createBtn.addEventListener("click", async () => {
  const title = document.getElementById("title").value || "My Note";
  const content = workspace.innerText || "";
  const res = await fetch("/create_or_update_doc", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({title, content, mode:"create"})
  });
  const data = await res.json();
  if(data.url){ alert("Created: " + data.url); window.open(data.url, "_blank"); checkAuthStatus(); }
  else alert("Error: " + JSON.stringify(data));
});

updateBtn.addEventListener("click", async () => {
  const content = workspace.innerText || "";
  const res = await fetch("/create_or_update_doc", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({content, mode:"update"})
  });
  const data = await res.json();
  if(data.url){ alert("Updated: " + data.url); window.open(data.url, "_blank"); checkAuthStatus(); }
  else alert("Error: " + JSON.stringify(data));
});

listBtn.addEventListener("click", async () => {
  const res = await fetch("/list_my_doc");
  const data = await res.json();
  alert(JSON.stringify(data, null, 2));
});

/* Save shortcut - ctrl+s for local save when editable */
window.addEventListener("keydown", e => {
  if((e.ctrlKey || e.metaKey) && e.key === "s"){
    e.preventDefault();
    saveLocal();
  }
});

checkAccess();
</script>
</body>
</html>
